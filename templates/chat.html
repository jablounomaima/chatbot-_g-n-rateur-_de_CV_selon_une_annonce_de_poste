<!DOCTYPE html>
<html>
<head>
  <title>ðŸ’¬ Assistant CV</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ðŸ”§ CorrigÃ© : espace en trop supprimÃ© dans l'URL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat {
      height: 70vh;
      overflow-y: scroll;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      background: white;
      border-radius: 8px;
    }
    .user {
      text-align: right;
      margin: 10px 0;
    }
    .bot {
      text-align: left;
      margin: 10px 0;
    }
    .suggestions-container {
      background-color: #f8f9fa;
      border-left: 4px solid #0d6efd;
      padding: 10px;
      margin-top: 8px;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .suggestion-item {
      margin-bottom: 8px;
    }
    .suggestion-item em {
      display: block;
      margin-bottom: 4px;
    }
    .btn-use {
      font-size: 0.85em;
      padding: 2px 8px;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">ðŸ’¬ Assistant GÃ©nÃ©rateur de CV</h2>
    <div id="chat" class="chat"></div>
    <input
      id="userInput"
      class="form-control"
      placeholder="Votre rÃ©ponse..."
      onkeydown="if(event.key === 'Enter') sendMessage()"
    >
    <button onclick="sendMessage()" class="btn btn-success mt-2">Envoyer</button>
    <a
      id="downloadBtn"
      href="/api/generate_cv"
      class="btn btn-primary mt-3 d-none"
      download
    >
      ðŸ“„ TÃ©lÃ©charger le CV
    </a>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const downloadBtn = document.getElementById("downloadBtn");

    // Ajouter un message du bot (avec 0, 1 ou plusieurs suggestions)
    function addBotMessage(text, suggestions) {
  const div = document.createElement("div");
  div.className = "bot";
  div.innerHTML = `<strong>ðŸ¤– Bot :</strong> ${text}`;

  if (Array.isArray(suggestions) && suggestions.length > 0) {
    const sugDiv = document.createElement("div");
    sugDiv.className = "suggestions-container";
    sugDiv.innerHTML = "<strong>ðŸ’¡ Suggestions :</strong><ul>";
    suggestions.forEach(s => {
      sugDiv.innerHTML += `
        <li><em>${s}</em>
          <button class="btn btn-sm btn-outline-success ms-2" onclick='useSuggestion(\`${s.replace(/`/g, '\\`')}\`)'>
            âœ…
          </button>
        </li>`;
    });
    sugDiv.innerHTML += "</ul>";
    div.appendChild(sugDiv);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

    // Utiliser une suggestion
    function useSuggestion(text) {
      userInput.value = text;
      userInput.focus();
      chat.scrollTop = chat.scrollHeight;
    }

    // Envoyer une rÃ©ponse
    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // Ajouter message utilisateur
      const userDiv = document.createElement("div");
      userDiv.className = "user";
      userDiv.innerHTML = `<strong>Vous :</strong> ${message}`;
      chat.appendChild(userDiv);

      // Nettoyer + scroll
      userInput.value = "";
      chat.scrollTop = chat.scrollHeight;

      // Envoyer au serveur
      fetch("/api/next", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => {
        if (!response.ok) throw new Error("Erreur HTTP: " + response.status);
        return response.json();
      })
      .then(data => {
        if (data.step === "done") {
          addBotMessage("âœ… CV gÃ©nÃ©rÃ© avec succÃ¨s ! Cliquez sur le bouton ci-dessous pour le tÃ©lÃ©charger.", null);
          downloadBtn.classList.remove("d-none");
        } else {
          // âœ… Envoie `data.suggestions` (liste) au lieu de `data.suggestion` (unique)
          addBotMessage(data.message, data.suggestions || []);
        }
      })
      .catch(err => {
        console.error("Erreur:", err);
        addBotMessage(
          "âŒ Une erreur est survenue. VÃ©rifiez que le serveur Flask est en marche et quâ€™il nâ€™y a pas dâ€™erreur dans la console."
        );
      });
    }

    // Message de bienvenue
    document.addEventListener("DOMContentLoaded", () => {
      addBotMessage("Bonjour ! Je suis votre assistant CV. Pour commencer, quel est votre nom complet ?", null);
    });
  </script>
</body>
</html>